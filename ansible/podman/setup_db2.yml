---
- name: Setup DB2 instance inside Podman container
  hosts: localhost
  connection: local
  become: false
  vars:
    container_name: db2

  tasks:
    - name: Wait for DB2 container to be running
      containers.podman.podman_container_info:
        name: "{{ container_name }}"
      register: container_info
      until: container_info.containers[0].State.Running
      retries: 10
      delay: 5

    - name: Run DB2 instance setup script
      containers.podman.podman_container_exec:
        name: "{{ container_name }}"
        command: /var/db2_setup/lib/setup_db2_instance.sh
        tty: true

    - name: Start DB2 as db2inst1 user
      containers.podman.podman_container_exec:
        name: "{{ container_name }}"
        command: su - db2inst1 -c 'db2start'
        tty: true

    - name: Connect to testdb
      containers.podman.podman_container_exec:
        name: "{{ container_name }}"
        command: su - db2inst1 -c 'db2 connect to testdb'
        tty: true

    - name: Run init.sql inside container
      containers.podman.podman_container_exec:
        name: "{{ container_name }}"
        command: su - db2inst1 -c 'db2 -tvf /docker-entrypoint-initdb.d/init.sql'
        tty: true

    - name: Healthcheck - ensure DB2 is available
      containers.podman.podman_container_exec:
        name: "{{ container_name }}"
        command: su - db2inst1 -c 'db2 connect to testdb'
        register: healthcheck_result
        failed_when: healthcheck_result.rc != 0
        tty: true
