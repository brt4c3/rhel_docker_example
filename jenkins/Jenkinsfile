pipeline {
    agent any

    parameters {
        booleanParam(name: 'check_podman_down', defaultValue: false, description: 'Tear down containers after run?')
    }

    environment {
        REPO_URL = "https://github.com/brt4c3/rhel_docker_example.git"
        REPO_NAME = "rhel_docker_example"
        REPO_DIR = "${REPO_NAME}_${BUILD_NUMBER}"
    }

    stages {
        stage('Check Internet Connectivity') {
            steps {
                script {
                    def connected = sh(script: "curl -sSf https://github.com > /dev/null", returnStatus: true)
                    if (connected != 0) {
                        error "‚ùå No internet connection. Exiting."
                    }
                }
            }
        }

        stage('Clone Repository') {
            steps {
                sh """
                    rm -rf ${REPO_DIR}
                    git clone ${REPO_URL} ${REPO_DIR}
                    ls ${REPO_DIR}
                """
            }
        }

        stage('Deploy Containers via Ansible') {
            steps {
                dir("${REPO_DIR}") {
                    sh """
                        echo 'üì¶ Deploying containers on remote Podman host via Ansible...'
                        ansible-playbook -i ansible/inventory ansible/deploy_podman.yml
                    """
                }
            }
        }

        stage('Configure DB2 via Ansible') {
            steps {
                dir("${REPO_DIR}") {
                    sh 'ansible-playbook -i ansible/inventory ansible/setup_db2.yml'
                }
            }
        }

        stage('Configure Open Liberty via Ansible') {
            steps {
                dir("${REPO_DIR}") {
                    sh 'ansible-playbook -i ansible/inventory ansible/setup_ol_app.yml'
                }
            }
        }

        stage('Optional Teardown') {
            when {
                expression { return params.check_podman_down == true }
            }
            steps {
                dir("${REPO_DIR}") {
                    sh 'ansible-playbook -i ansible/inventory ansible/teardown_podman.yml || true'
                }
            }
        }
    }

    post {
        always {
            script {
                echo "üßπ Cleaning up workspace..."
                cleanWs()
            }
        }
    }
}
