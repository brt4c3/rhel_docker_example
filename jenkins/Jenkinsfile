pipeline {
    agent any

    environment {
        IIM_ZIP = "MW/agent.installer.linux.gtk.x86_64_1.9.2008.20240227_0018.zip"
        WLP_ZIP = "MW/wlp-webProfile8-java8-linux-x86_64-24.0.0.6.zip"
        REPO_URL = "https://github.com/brt4c3/rhel_docker_example.git"
        REPO_DIR = "rhel_docker_example"
    }

    stages {
        stage('Check Prerequisites') {
            steps {
                script {
                    if (!fileExists(env.IIM_ZIP)) {
                        error "Missing IIM installer zip at ${env.IIM_ZIP}"
                    }
                    if (!fileExists(env.WLP_ZIP)) {
                        error "Missing WLP Web Profile zip at ${env.WLP_ZIP}"
                    }
                }
            }
        }

        stage('Clone Git Repository') {
            steps {
                sh """
                rm -rf ${env.REPO_DIR}
                git clone ${env.REPO_URL} ${env.REPO_DIR}
                """
            }
        }

        stage('Start Podman Compose') {
            steps {
                dir("${env.REPO_DIR}") {
                    sh 'podman-compose up -d --build'
                }
            }
        }

        stage('Run Full Ansible Stack') {
            steps {
                sh 'ansible-playbook -i ansible/inventory ansible/main.yml'
            }
        }

    }

    post {
        always {
            dir("${env.REPO_DIR}") {
                sh 'podman-compose down || true'
            }
        }
    }
}
